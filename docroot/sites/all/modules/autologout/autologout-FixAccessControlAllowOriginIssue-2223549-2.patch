From 52a801597f4e265568e352bcb61c954006d3cab8 Mon Sep 17 00:00:00 2001
From: wdouglascampbell <wdouglascampbell@hotmail.com>
Date: Sat, 29 Mar 2014 05:52:11 +0800
Subject: [PATCH] Issue #2223549 by wdouglascampbell: Provide alternate logout
 method to address Access-Control-Allow-Origin issue.

---
 autologout.admin.inc |    7 +++++++
 autologout.js        |   24 ++++++++++++++----------
 autologout.module    |    2 ++
 3 files changed, 23 insertions(+), 10 deletions(-)

diff --git a/autologout.admin.inc b/autologout.admin.inc
index ebfadd7..7994450 100644
--- a/autologout.admin.inc
+++ b/autologout.admin.inc
@@ -73,6 +73,13 @@ function autologout_settings() {
     '#description' => t('Enable this if you want users to logout right away and skip displaying the logout dialog.'),
   );
 
+  $form['autologout_use_alt_logout_method'] = array(
+    '#type' => 'checkbox',
+    '#title' => t('Use alternate logout method'),
+    '#default_value' => variable_get('autologout_use_alt_logout_method', FALSE),
+    '#description' => t('Normally when auto logout is triggered, it is done via an AJAX service call. Sites that use an SSO provider, such as CAS, are likely to see this request fail with the error "Origin is not allowed by Access-Control-Allow-Origin". The alternate appraoch is to have the auto logout trigger a page redirect to initiate the logout process instead.'),
+  ); 
+
   $form['autologout_message']  = array(
     '#type' => 'textarea',
     '#title' => t('Message to display in the logout dialog'),
diff --git a/autologout.js b/autologout.js
index cc3203c..1cf0114 100644
--- a/autologout.js
+++ b/autologout.js
@@ -143,18 +143,22 @@
       }
 
       function logout() {
-        $.ajax({
-          url: Drupal.settings.basePath + "?q=autologout_ahah_logout",
-          type: "POST",
-          success: function() {
-            window.location = localSettings.redirect_url;
-          },
-          error: function(XMLHttpRequest, textStatus) {
-            if (XMLHttpRequest.status == 403 || XMLHttpRequest.status == 404) {
+        if (localSettings.use_alt_logout_method) {
+          window.location = Drupal.settings.basePath + "?q=autologout_ahah_logout";
+        } else {
+          $.ajax({
+            url: Drupal.settings.basePath + "?q=autologout_ahah_logout",
+            type: "POST",
+            success: function() {
               window.location = localSettings.redirect_url;
+            },
+            error: function(XMLHttpRequest, textStatus) {
+              if (XMLHttpRequest.status == 403 || XMLHttpRequest.status == 404) {
+                window.location = localSettings.redirect_url;
+              }
             }
-          }
-        });
+          });
+        }
       }
 
       /**
diff --git a/autologout.module b/autologout.module
index 481055b..22a7611 100644
--- a/autologout.module
+++ b/autologout.module
@@ -370,6 +370,7 @@ function autologout_init() {
   $redirect_url = variable_get('autologout_redirect_url', 'user/login');
   $redirect_query = drupal_get_destination() + array('autologout_timeout' => 1);
   $no_dialog = variable_get('autologout_no_dialog', FALSE);
+  $use_alt_logout_method = variable_get('autologout_use_alt_logout_method', FALSE);
   drupal_add_library('system', 'ui.dialog');
 
   // Get all settings JS will need for dialog.
@@ -382,6 +383,7 @@ function autologout_init() {
     'title' => t('@name Alert', array('@name' => variable_get('site_name', 'Drupal'))),
     'refresh_only' => $refresh_only,
     'no_dialog' => $no_dialog,
+    'use_alt_logout_method' => $use_alt_logout_method,
   );
 
   // If this is an AJAX request, then the logout redirect url should still be
-- 
1.7.7.6

